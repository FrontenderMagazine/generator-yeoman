# Пишем свой генератор для Yeoman

В настоящее время рабочих процессов разработки фронтенда достаточно много: 
кто-то любит препроцессоры CSS, а кто-то — не очень; кто-то любит 
CoffeeScript, а кто-то — не очень; кто-то проверяет свой код перед релизом, 
а кто-то нет… С появлением инструментов автоматизации и управления 
компонентами (вроде *Grunt*, *Bower* и им подобных) я условно делю 
процессы разработки на ручные (включающие только процессы ручного 
скаффолдинга и более механической работы с исходными файлами) и 
автоматизированные (те процессы, в которых замешано использование 
вышеперечисленных инструментов). Думаю, что вы со мной согласитесь.

Видов всего два, а реализаций много. Кто-то руками копирует 
*HTML5 BOILERPLATE*, кто-то копирует какую-то свою заготовку, а кто-то и вовсе 
использует *Yeoman* для скаффолдинга проекта с навинченными на него *Grunt* и 
*Bower*. Эта статья для тех, кто пользуется последним подходом или к этому 
стремится.

![Yeoman][Yeoman]

Ранее я уже писал о том, что такое Yeoman и как его использовать. И в 
этой статье я буду полагать, что читатель ознакомился с предыдущей. 
Как вы уже знаете, Yeoman несёт в себе не просто скаффолдер проекта, а целый 
рабочий процесс, конкретную реализацию которого вы задаёте используя 
определённый генератор. К примеру, рассмотренный в предыдущей статье генератор 
`webapp` имеет наиболее общие задачи для *Grunt*, которые, скорее всего, вам 
придётся дополнить своими специфичными задачами. 
При продолжительном использовании *Yeoman* вам будет не хватать одного, 
наиболее общего, генератора. Их уже достаточно много, чтобы попробовать 
подобрать решение для конкретного специфичного процесса разработки. Но… Если 
ничего не нашлось, а вы всё ещё чувствуете острую необходимость в генераторе и 
полны энтузиазма, то имеет смысл написать свой генератор.

Во-первых, сразу хочу акцентировать ваше внимание на простом правиле — вам 
нужно писать свой генератор, если:

1. ваш рабочий процесс настолько специфичен, что требует того, что ещё не было 
разработано ранее и выложено на *GitHub* или в *npm*;
1. ваш рабочий процесс, используемый в новом проекте обязательно повторится в 
одном или нескольких следующих проектах, иначе работа над спецификой в 
генераторе теряет свой смысл;
1. при всех перечисленных причинах вы готовы потратить неопределённое 
количество времени на поиск и тестирование подходящих вам компонентов 
(npm-пакетов и *Bower*-компонентов).
Иначе, советую не слишком утруждаться и просто воспользоваться уже имеющимся 
генератором, подправив затем *Gruntfile.js* и npm-пакеты так, чтобы это 
подходило вам.

Итак, вы всё же решили написать свой генератор. Замечательно! К делу!
Для начала нужно понимать принцип работы любого скаффолдера. Скаффолдеру 
отдают на выполнение некоторый сценарий, содержащий описание процесса 
развёртки нового проекта в понятиях, определённых самим скаффолдером (т.е. его 
API). Обычно сценарий команды создания папок, файлов и обработки шаблонов. 

Как бы парадоксально это ни звучало, но существует генератор генераторов для 
*Yeoman*. Это npm-пакет (`generator-generator`), который на основе всё того же 
*Yeoman* разворачивает вам шаблон нового генератора. В целом, для начала 
работы над задуманным генератором вам необходимо установить `yo` и 
`generator-generator`. Делаем это командой

	npm install -g yo generator-generator

Как известно, все генераторы для *Yeoman* должны иметь подобное именование: 
`generator-name`, где `name` — название генератора. В дальнейшем для 
использования генератора нужно будет выполнить `yo name`. Это я к тому, что 
вам нужно определиться с названием вашего генератора и создать директорию вида 
`generator-name` (в моём случае это будет `generator-new`) и запустите из неё 
тот самый генератор для генераторов выполнив команду: `yo generator`. *Yeoman* 
задаст вам пару вопросов, ответы на которые необходимы ему для генерации 
`package.json`. Позднее вы сможете подправить свои ответы именно в этом файле. 
`package.json` может содержать зависимости, которые необходимы вашему 
генератору и некоторую дополнительную информацию о генераторе.

![Пример использования генератора Yeoman][Yeoman-generator-example]

В итоге вы получите шаблон желаемого генератора с шаблонами и 
конфигурационными файлами. Предсказуемо, что главным файлом, описывающим 
логику работы вашего генератора будет являться `index.js` в директории `app`. 
У вас получится приблизительно следующая структура файлов:

	├── app
	│   ├── index.js
	│   └── templates
	│       ├── _bower.json
	│       ├── _package.json
	│       ├── editorconfig
	│       ├── jshintrc
	│       └── travis.yml
	├── test
	│   ├── test-creation.js
	│   └── test-load.js
	├── .editorconfig
	├── .gitattributes
	├── .gitignore
	├── .jshintrc
	├── .travis.yml
	├── LICENSE
	├── package.json
	└── README.md

На первых порах наибольший интерес будут представлять файл `index.js` и 
шаблоны — файлы из директории `app/templates`.

Сейчас ваш генератор обладает наименьшим функционалом — он может создать пару 
директорий и скопировать туда несколько файлов из директории с шаблонами. 
Чтобы было удобнее продолжать процесс разработки генератора, советую выполнить 
команду `npm link` в директории генератора. Команда создаст символическую 
ссылку на генератор и поместит её в директорию глобальных npm-пакетов, что 
сделает ваш генератор доступным для выполнения из любого каталога на жёстком 
диске. Хотя физически директория генератора не обязательно должна будет 
находиться в директории для глобальных модулей.

Можете попробовать запустить генератор. Делается это, конечно же, с помощью 
команды `yo name`. У меня это будет `yo new`.
*Yeoman* спросит вас «Would you like to enable this option?». Это тестовый 
вопрос. Ответ на него ни на что не влияет и в ходе выполнения скаффолдинга ваш 
генератор создаст директории `app` и `app/templates`, а также скопирует файлы 
шаблонов в корень и переименует их. В прочем, пока это бесполезные файлы и 
папки, мы вернёмся к ним немного позднее. А пока давайте углубимся в суть 
генераторов и взглянем на `app/index.js`.

В первую очередь рассмотрим вопросы, задаваемые пользователю в процессе 
скаффолдинга. Как мы успели заметить, сейчас в сценарии содержится всего один 
вопрос и тот бесполезный:

	var prompts = [{
    	type: 'confirm',
    	name: 'someOption',
    	message: 'Would you like to enable this option?',
    	default: true
	}];

Переменная `prompts` является массивом, который содержит отдельные объекты для 
каждого из вопросов, задаваемых пользователю. Вопросы к пользователю в 
*Yeoman* осуществляются с использованием *Inquirer.js*. Существует несколько 
типов вопросов к пользователю: `input`, `confirm`, `list` и `rawlist`. 
Подробнее [о типах вопросов (свойство type)][prompt-types] и 
[других свойствах объекта вопроса][question-object] читайте в документации.

Рядом с массивом вопросов расположена функция обработки вопросов:

	this.prompt(prompts, function (props) {
    	this.someOption = props.someOption;

    	cb();
	}.bind(this));

Метод `prompt` принимает в качестве аргументов массив с вопросами `prompts` и 
функцию обратного вызова, выполняющуюся после получения от пользователя 
ответов на все вопросы из `prompts`. Объект, который принимает функция 
обратного вызова содержит ответы на вопросы. Ответы есть свойства этого 
объекта, которые носят имена, соответствующие свойству `name` объекта вопроса. 
В нашем примере видно, что имелся объект вопроса со свойством 
`name: someOption`, а `props` содержит свойство `someOption`, значением 
которого является ответ на вопрос.
Таким образом мы получаем ответы от пользователя для дальнейшего использования 
их в сценарии и при обработке шаблонов.

Теперь вернёмся к началу файла `index.js` и рассмотрим оставшееся его 
содержимое. 

	var NewGenerator = module.exports = function NewGenerator(args, options, config) {
		yeoman.generators.Base.apply(this, arguments);
		this.on('end', function () {
			this.installDependencies({ skipInstall: options['skip-install'] });
		});
		this.pkg = JSON.parse(this.readFileAsString(path.join(__dirname, '../package.json')));
	};

	util.inherits(NewGenerator, yeoman.generators.Base);

`NewGenerator` — это функция-конструктор, которая будет запущена первой. 
Из коробки она:

- связывает генератор с `Base` (Yeoman API);
- создаёт обработчик события `end` (выполняется, когда методы прототипа завершают выполнение, к нему мы ещё вернёмся);
- даёт доступ к файлу `package.json` нашего генератора.

Далее вы увидите подобные объявления:

	NewGenerator.prototype.askFor = function askFor() {
     	// …
	};

В качестве методов прототипа объявляются функции, описывающие действия, 
которые должен выполнять генератор. Важным нюансом является то, что 
объявленные методы будут вызываться в том порядке, в котором они описаны в 
сценарии. Никто не запрещает создать всего один метод, но обычно, действия 
разделяют на отдельные методы для удобного представления. Например, в шаблоне 
имеется ещё пара методов прототипа:

	NewGenerator.prototype.app = function app() {
		this.mkdir('app');
		this.mkdir('app/templates');
		this.copy('_package.json', 'package.json');
		this.copy('_bower.json', 'bower.json');
	};

	NewGenerator.prototype.projectfiles = function projectfiles() {
		this.copy('editorconfig', '.editorconfig');
		this.copy('jshintrc', '.jshintrc');
	};

Пришло время наиболее интересной части — работа с файлами. `this.mkdir` 
создаёт указанную директорию в том месте, где был запущен процесс скаффолдинга 
с использованием этого генератора. `this.copy` копирует указанный файл. Первым 
параметром принимает имя файла в директории с шаблонами генератора (файл-
источник), вторым параметром — конечное имя файла.
Это две наиболее часто употребляемые команды при работе со статичными файлами 
и директориями. Вам возможно ничего другого больше и не понадобится, но на 
всякий случай есть [документация к API][yeoman-generator-api].

## Работа с шаблонами

Первым делом стоит отметить, что в официальной документации предлагается 
именовать файлы-шаблоны с использованием знака подчеркивания в начале. Это 
довольно символично, поскольку в *Yeoman* за обработку шаблонов отвечает 
шаблонизатор [Lo-Dash][lo-dash].

Собственно сам шаблон какого-либо файла будет иметь в коде директивы и 
операторы, воспринимаемые шаблонизатором вроде, `<%= pkg.version %>`. А также, 
доступны функциональные возможности *Lo-Dash*: `<%= _.slugify(someVar) %>`. 
Обработка шаблонов закреплена за методом `template`:

	NewGenerator.prototype.app = function app() {
		//…
		this.template('Gruntfile.js', 'Gruntfile.js');
		this.template('index.html', 'index.html');
		//…
	};

Аналогично с функцией `this.copy`, `template` в качестве первого параметра 
принимает имя файла-шаблона в директории `templates`, в качестве второго — имя 
выходного файла, обработанного шаблонизатором.

Обычно, шаблонами выступают файлы, из которых в итоге формируют `package.json`
и `bower.json`, а также некоторые другие конфигурационные файлы. Если вам не нравится концепция шаблонов, вы можете писать в файлы непосредственно из генератора (метод [this.write()][actions-write]).

## Завершение сценария

Ключевой особенностью скаффолдера *Yeoman* является то, что он взаимодействует 
с *Grunt* и *Bower*. Внимательно взглянув на функцию-конструктор в `index.js` 
можно обнаружить метод установки зависимостей, вызываемый по завершению 
выполнения всех функций сценария:

	this.on('end', function () {
		this.installDependencies({ skipInstall: options['skip-install'] });
	});

Метод `installDependencies` запускает загрузку и установку как npm-пакетов, 
так и Bower-компонентов в случае, если загрузка не отменена опцией 
`skip-install` при запуске скаффолдинга. Если установка модулей была отменена 
использованием опции `skip-install`, пользователь вашего генератора сможет 
установить их позднее, выполнив команды установки пакетов для *npm* и *Bower*.
 
## Суб-генераторы

Суб-генераторы — это самостоятельные генераторы, не имеющие логического 
предназначения без основного генератора. Отличный пример — генератор и 
суб-генераторы [AngularJS][generator-angular]. В нём суб-генераторы отвечают 
за добавление компонентов приложения, таких как маршруты, контроллеры, 
представления и т.д.
Также суб-генераторы используют для разбиения логики генерации приложения на 
более мелкие самостоятельные части, вызываемые основным генератором. Пример 
такого использования можно найти в генераторе 
[Backbone.js][generator-backbone]. 
Итак, если вашему генератору требуются суб-генераторы, следующие действия 
приведут к желаемому результату.

1. Из директории с вашим генератором выполните: 
`yo generator:subgenerator "name"`, где `name` — имя суб-генератора.
2. Откройте `{name}/index.js`. Структура файла аналогична основному 
генератору, поэтому, написав основной генератор, вам не составит труда 
написать логику суб-генератора. Все правила написания логики генератора, 
описанные ранее, работают и для суб-генераторов.
3. Вызов команды `yo {your_generator}:{your_subgenerator} "args"` приведёт к 
запуску созданного вами суб-генератора `your_subgenerator` генератора 
`your_generator` с аргументами `args`.

## Полезные ссылки и что читать/смотреть дальше

- Первым делом, конечно, 
[официальная документация][yeoman-write-first-generator].
- Не забываем про некоторые полезные сниппеты для написания генератора 
приведены на официальном сайте (http://yeoman.io/generators.html#snippets). 
- По [тэгу yeoman на HTML5Rocks][yeoman-on-the-html5roks] можно найти свежие 
выпуски «The Yeoman Monthly Digest», содержащего достаточно много полезных 
туториалов по написанию и использованию различного рода генераторов.
- [Видео по созданию генератора][yeoman-generator-video-1]. Опубликовано в мае 
2013, поэтому немного отличается от настоящих реалий. Но концепция та же.
- [Каталог open-source генераторов для Yeoman][yeoman-generators-list].
- [Документация к API генераторов Yeoman][yeoman-generator-api]. В нём описаны 
все методы, доступные для использования в генераторе.


[prompt-types]: https://github.com/SBoudrias/Inquirer.js#prompts-type
[question-object]: https://github.com/SBoudrias/Inquirer.js#question
[yeoman-generator-api]: https://github.com/yeoman/generator/wiki/actions
[lo-dash]: http://lodash.com
[generator-angular]: https://github.com/yeoman/generator-angular#generators
[generator-backbone]: https://github.com/yeoman/generator-backbone/blob/master/all/index.js#L33
[yeoman-write-first-generator]: http://yeoman.io/generators.html#writing-your-first-generator
[yeoman-on-the-html5roks]: http://updates.html5rocks.com/tag/yeoman
[yeoman-generator-video-1]: https://www.youtube.com/watch?v=q-KRiwXhbhU
[yeoman-generators-list]: http://yeoman.io/community-generators.html
[actions-write]: https://github.com/yeoman/generator/wiki/actions#actionswrite
[Yeoman]: img/yeoman.png "Yeoman"
[Yeoman-generator-example]: img/generator.png "Примет работы генератора Yeoman"
